# Introduction
This work is based on Inter-GPS(https://arxiv.org/abs/2105.04165) and we propose a new way to get theorem sequences.


## The Dataset

The Data is geometry3k from Inter-GPS.
First, unzip data files into `data/geometry3k`:

```shell
. data/unzip_data.sh
```

You can alternatively visit the [Google Drive link](https://drive.google.com/drive/folders/1d05WYXtlgKIoaPpK1v94LYph_heiXM7Z?usp=sharing) to download the Geometry dataset and unzip it.



## Requirements

```text
Python 3.6+
torch 1.7.1
transformers 4.8.2
python3-pip
```

Install all required python dependencies:

```
pip3 install -r requirement.txt
```



## Run parser from Scratch

### Text Parser

Parse the problem text into literals (logic forms). 

```shell
cd text_parser
python text_parser.py
```

### Diagram Parser

The diagram parser converts a problem diagram into literals (logic forms). Only the most core running code is shown as following. If you would like to know every detail, please refer to this [README](https://github.com/lupantech/InterGPS/blob/main/diagram_parser/README.md) file.

Unzip our detection results of text regions and symbols:

```shell
cd detection_results
unzip -d box_results box_results.zip
unzip -d ocr_results ocr_results.zip
```

 Generate diagram logic forms by running the following command:

~~~shell
cd parser
python diagram_parser.py \
--data_path ../../data/geometry3k \
--ocr_path ../detection_results/ocr_results \
--box_path ../detection_results/box_results \
--output_path ../diagram_logic_forms.json
~~~



## Theorem Predictor

### Preparation period(This is same as Inter-GPS)

1. Generate template-based and random-ordered theorem sequences:
```shell
cd theorem_predict/tools
python generate_random_seqs.py
```

It generates two files:

- `results/train/pred_seqs_train_l30_n100_template.json`: 100 template-based sequences with a maximum length of 30 for each training data
- `results/test/pred_seqs_test_l100_random.json`: 1 random-order sequence with a maximum length of 100 for each testing data

2. (Optional) Generate pseudo-optimal theorem sequences for each training data:

```shell
python check_theorem_seq.py
```

It will take about 20 hours to attempt 100 tries over all training data! If you want to save time, just skip this step and use our generated data in [`theorem_predict/results/train/splits`](https://github.com/lupantech/InterGPS/tree/main/theorem_predict/results/train/splits) instead.

### GAN and CER

1. Encode the logic_forms of questions into 10-dimension vectors:
```shell
cd text_parser
python text_one_hot_zl.py
```
This generate one file:
- `../text_one_hot.json`: the 10-dimension vectors of all problems in geometry-3K.

2. Train GAN and generate theorem sequences:
```shell
cd theorem_predict_GAN
python wGAN_attention.py
```
This generate one file:
- `../at_gene_seq.json`: theorem sequences of all test questions generated by wGAN.
- If running multiple times, it will get multiple files.

3. Pretreat generated sequences:
```shell
cd evolutionary reasoning
python seq_pre_treatment.py
```
This generate one file:
- `../at_seq_pretreat.json`: change the numbers in sequence into whole numbers in range[1, 17].


4. Optimize sequences using counter-factual evolutionary reasoning: 
```shell
cd evolutionary reasoning
python ER.py
```
This generate 100 file corresponding to the number of 100 test questions:
- `'../ER_seq/' + str(problem_number) + '.json'`: theorem sequences of all test questions from CER.

5. Merge sequences from wGAN and CER:
```shell
cd evolutionary reasoning
python merge_ER_seq.py
python merge_ER_and_gene_seq.py
```
This generate one file:
- `../merge_GA_and_gene_seq.json`: this is the final results of our method.


### Symbolic Solver

Finally, run the symbolic solver with the *Final* search strategy (*predict* + *low-first*) over *generated* logic forms(This is also from Inter-GPS):

```shell
cd symbolic_solver
python test.py --label final_new \
--strategy final \
--text_logic_form_path ../text_parser/text_logic_forms.json \
--diagram_logic_form_path ../diagram_parser/diagram_logic_forms.json \
--predict_path ../merge_GA_and_gene_seq.json
```

## Citation

If the paper,  the dataset, or the code helps you, please cite the paper in the following format :

```

```



## Q&A

If you encounter any problem, feel free to either directly contact the first authors.

